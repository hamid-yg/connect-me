<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Video Call Simulation</title>
    </head>
    <body>
        <h1>Video Call Simulation</h1>
        <div>
            <video id="localVideo" autoplay></video>
            <video id="remoteVideo" autoplay></video>
        </div>
        <div>
            <button id="startCall">Start Call</button>
            <button id="endCall">End Call</button>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js"></script>
        <script>
            const socket = io('http://localhost:3000');
            const localVideo = document.getElementById('localVideo');
            const remoteVideo = document.getElementById('remoteVideo');
            const startCallButton = document.getElementById('startCall');
            const endCallButton = document.getElementById('endCall');
            let localStream;
            let remoteStream;
            let recorder;

            startCallButton.addEventListener('click', async () => {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    localVideo.srcObject = localStream;
                    remoteStream = new MediaStream();
                    remoteVideo.srcObject = remoteStream;
                    socket.emit('startCall');
                    recorder = new MediaRecorder(localStream, { mimeType: 'video/webm; codecs=vp9,opus' });
                    recorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            socket.emit('recordedData', event.data);
                        }
                    };
                    recorder.start();
                } catch (error) {
                    console.error(error);
                }
            });

            endCallButton.addEventListener('click', () => {
                socket.emit('endCall');
                localStream.getTracks().forEach((track) => track.stop());
                remoteStream.getTracks().forEach((track) => track.stop());
                recorder.stop();
            });

            socket.on('startCall', () => {
                console.log('Received start call signal from server');
            });

            socket.on('endCall', () => {
                console.log('Received end call signal from server');
                localStream.getTracks().forEach((track) => track.stop());
                remoteStream.getTracks().forEach((track) => track.stop());
                recorder.stop();
            });

            socket.on('recordedData', (data) => {
                remoteStream.addTrack(new MediaStreamTrack(data));
            });
        </script>
    </body>
</html>